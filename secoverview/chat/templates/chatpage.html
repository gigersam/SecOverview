{% extends "layout.html" %}

{% block content %}

    <!-- CSRF Token -->
    <form method="post" style="display: none;">
        {% csrf_token %}
    </form>

    <!-- Chat Box -->
    <div id="chat-page">
        <div id="chat-header">Ollama Chat</div>
        <div id="chat-box-full">
            {% for msg in messages %}
                <p><b>You:</b> {{ msg.user_input }}</p>
                <p><b>{{ msg.model_response.model }}:</b> {{ msg.model_response }}</p>
            {% endfor %}
        </div>
        <div id="input-group mb-3">
            <input type="text" class="form-control" id="user_input" placeholder="Type your message" aria-describedby="send-btn">
            <button class="btn btn-dark" id="send-btn">Send</button>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const chatBox = document.getElementById("chat-box");
            const userInput = document.getElementById("user_input");
            const sendBtn = document.getElementById("send-btn");

            function getCSRFToken() {
                return document.querySelector("[name=csrfmiddlewaretoken]").value;
            }

            async function sendMessage() {
                let userInputValue = userInput.value.trim();
                if (userInputValue === "") return;

                // Ensure chatBox is found before using it
                if (!chatBox) {
                    console.error("Chat box not found!");
                    return;
                }

                chatBox.innerHTML += `<p><b>You:</b> ${userInputValue}</p>`;

                const response = await fetch("", {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/x-www-form-urlencoded",
                        "X-CSRFToken": getCSRFToken()
                    },
                    body: new URLSearchParams({ "user_input": userInputValue })
                });

                const data = await response.json();
                chatBox.innerHTML += `<p><b>${data.response.model}:</b> {'model': '${data.response.model}', 'message': '${data.response.message}', 'tokens_used': ${data.response.token_used}}</p>`;

                userInput.value = "";
                chatBox.scrollTop = chatBox.scrollHeight; // Auto-scroll
            }

            sendBtn.addEventListener("click", sendMessage);
            userInput.addEventListener("keypress", function(event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    sendMessage();
                }
            });
        });
    </script>

{% endblock %}